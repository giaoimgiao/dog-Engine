# 社区功能重大改进

## 问题分析

**原始问题**：社区创作功能依赖用户自己部署的服务器，如果服务器不在线，其他用户无法获取角色卡。同时，服务器使用内存存储，重启后数据丢失。

## 解决方案

### 1. 服务器持久化存储 ✅

**改进内容**：
- 将内存存储（`Map`、`Array`）改为 JSON 文件持久化存储
- 数据保存在 `server/community/data/` 目录下
- 自动保存机制：
  - 每次数据变更后立即保存
  - 每30秒自动保存一次
  - 进程退出时保存数据
- 启动时自动从磁盘加载历史数据

**技术实现**：
```javascript
// 数据文件
- server/community/data/users.json      // 用户账户
- server/community/data/prompts.json    // 角色卡
- server/community/data/announcements.json // 公告
```

**优势**：
- ✅ 服务器重启后数据不丢失
- ✅ 支持数据备份和迁移
- ✅ 服务器部署后可持续运行

---

### 2. 默认角色卡库 ✅

**改进内容**：
- 内置10个优质AI角色卡，涵盖多种小说类型
- 首次打开社区时自动显示默认角色卡
- 用户可以一键将默认角色卡保存到本地库

**内置角色卡**：
1. 冷硬派侦探 - 推理小说风格
2. 优雅贵族 - 古典文学风格
3. 科技黑客 - 赛博朋克风格
4. 古代武者 - 武侠小说风格
5. 幽默记者 - 现实题材风格
6. 冷酷杀手 - 动作悬疑风格
7. 神秘巫师 - 奇幻小说风格
8. 热血少年 - 青春励志风格
9. 智慧长者 - 哲理小说风格
10. 冷艳女特工 - 谍战小说风格

**使用方式**：
- 无需配置，直接可用
- 点击"保存到本地"按钮，将内置角色卡添加到本地库
- 支持复制、修改、扩展

---

### 3. 导入/导出功能 ✅

**改进内容**：
- **导出功能**：将当前角色卡库导出为JSON文件
- **导入功能**：从JSON文件批量导入角色卡
- 支持分享角色卡库给其他用户

**使用场景**：
1. **备份数据**：定期导出角色卡库作为备份
2. **分享资源**：导出精选角色卡分享给朋友
3. **迁移数据**：在不同设备间迁移角色卡库
4. **协作创作**：团队成员共享角色卡库

**操作步骤**：
```
导出：点击"导出"按钮 → 自动下载JSON文件
导入：点击"导入"按钮 → 选择JSON文件 → 自动导入到本地
```

---

### 4. 智能数据源管理 ✅

**改进内容**：
- 自动识别并显示当前数据来源
- 三级降级策略：云端 → 本地 → 默认

**数据源优先级**：
1. **云端数据** (☁️) - 优先尝试从远程服务器获取
2. **本地数据** (💾) - 云端不可用时使用本地数据
3. **默认角色卡** (📦) - 本地也没有时显示内置角色卡

**数据源标识**：
- 每个角色卡右上角显示来源标签
- 绿色 = 云端，灰色 = 本地，蓝色 = 内置
- 内置角色卡不可删除/编辑，确保始终可用

---

## 用户体验提升

### 新用户体验
- ✅ 首次打开即可看到10个优质角色卡
- ✅ 无需配置服务器即可使用基础功能
- ✅ 可以立即复制角色卡到AI写作中使用

### 老用户体验
- ✅ 历史数据不会丢失（本地存储 + 服务器持久化）
- ✅ 支持数据备份和恢复
- ✅ 可以导入其他用户分享的角色卡库

### 服务器管理员
- ✅ 服务器重启后数据自动恢复
- ✅ 数据文件可以备份和迁移
- ✅ 支持手动编辑JSON文件管理数据

---

## 完整功能清单

### 角色卡管理
- [x] 创建新角色卡（本地/云端）
- [x] 编辑角色卡（本地/云端）
- [x] 删除角色卡（本地/云端）
- [x] 点赞角色卡
- [x] 复制角色卡内容
- [x] 公开/私密切换

### 数据管理
- [x] 导出角色卡库（JSON格式）
- [x] 导入角色卡库（JSON格式）
- [x] 默认角色卡一键保存
- [x] 自动数据源切换

### 服务器功能
- [x] 用户注册/登录
- [x] 数据持久化存储
- [x] 自动保存机制
- [x] 进程信号处理

---

## 技术架构

### 前端 (Next.js)
```
src/app/community/page.tsx     - 社区主页面
src/data/default-prompts.json  - 默认角色卡数据
src/lib/community-remote.ts    - 远程API调用
src/lib/actions/community.ts   - 本地数据操作
```

### 后端 (Express.js)
```
server/community/server.js     - 社区服务器
server/community/data/         - 持久化数据目录
  ├── users.json              - 用户数据
  ├── prompts.json            - 角色卡数据
  └── announcements.json      - 公告数据
```

---

## 部署说明

### 首次部署
1. 部署Next.js应用（前端）
2. （可选）部署社区服务器（后端）
3. 无需部署也能使用默认角色卡

### 服务器部署
```bash
cd server/community
npm install
node server.js
```

### 环境变量
```env
PORT=8080                          # 服务器端口
JWT_SECRET=your-secret-key         # JWT密钥
ADMIN_USER=admin                   # 管理员用户名
ADMIN_PASS=password                # 管理员密码
```

---

## 数据迁移

### 备份数据
```bash
# 备份服务器数据
cp -r server/community/data /path/to/backup/

# 或通过前端导出功能
点击"导出"按钮下载JSON文件
```

### 恢复数据
```bash
# 恢复服务器数据
cp -r /path/to/backup/data server/community/

# 或通过前端导入功能
点击"导入"按钮上传JSON文件
```

---

## 常见问题

### Q: 服务器重启后数据会丢失吗？
A: 不会！现在使用JSON文件持久化存储，所有数据都会自动保存。

### Q: 如果不部署服务器能用吗？
A: 可以！会自动使用本地存储和默认角色卡，完全可用。

### Q: 如何分享角色卡给朋友？
A: 点击"导出"按钮导出JSON文件，发送给朋友，朋友点击"导入"即可。

### Q: 默认角色卡可以修改吗？
A: 默认角色卡不可直接修改，但可以点击"保存到本地"后在本地修改。

### Q: 数据存储在哪里？
A: 
- 本地数据：浏览器 localStorage
- 服务器数据：`server/community/data/` 目录
- 默认角色卡：代码内置，不可修改

---

## 更新日志

**2025-10-06**
- ✅ 服务器改用JSON文件持久化存储
- ✅ 添加10个默认优质角色卡
- ✅ 实现角色卡导入/导出功能
- ✅ 优化UI显示数据来源
- ✅ 添加一键保存默认角色卡功能
- ✅ 完善数据降级策略

---

## 总结

通过这次改进，社区功能实现了：
1. **数据持久化** - 不再担心数据丢失
2. **开箱即用** - 内置优质角色卡，无需配置
3. **数据自由** - 支持导入导出，方便分享
4. **智能降级** - 自动切换数据源，始终可用

现在用户无论是否部署服务器，都能充分使用社区功能！

